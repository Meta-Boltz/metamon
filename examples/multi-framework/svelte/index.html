<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Svelte Chunk Loading Examples - MTM Framework</title>
    <meta name="description" content="Comprehensive Svelte chunk loading examples demonstrating safe property assignment and error-free dynamic component loading.">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üß°</text></svg>">
    
    <!-- Shared Styles -->
    <link rel="stylesheet" href="../assets/styles/common.css">
    
    <!-- Svelte-specific styles -->
    <style>
        .svelte-container {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            min-height: 100vh;
            padding: 20px 0;
        }
        
        .svelte-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 30px;
            margin: 20px auto;
            max-width: 1200px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .svelte-logo {
            font-size: 4rem;
            margin-bottom: 1rem;
            display: block;
        }
        
        .svelte-title {
            color: #2c3e50;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .svelte-subtitle {
            color: #7f8c8d;
            font-size: 1.2rem;
            margin-bottom: 2rem;
        }
        
        .svelte-examples {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .example-card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #ff6b35;
        }
        
        .example-title {
            color: #2c3e50;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .example-description {
            color: #7f8c8d;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        
        .svelte-component {
            border: 2px solid #ff6b35;
            border-radius: 8px;
            padding: 20px;
            background: #fff8f5;
            margin: 15px 0;
        }
        
        .loading-state {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #ff6b35;
            font-weight: 600;
        }
        
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e0e0e0;
            border-top: 2px solid #ff6b35;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .success-indicator {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 10px 15px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: 500;
        }
        
        .metrics-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        
        .svelte-feature {
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 600;
        }
        
        .reactive-demo {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }
        
        .counter-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 15px 0;
        }
        
        .svelte-btn {
            background: #ff6b35;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }
        
        .svelte-btn:hover {
            background: #e55a2b;
        }
        
        .counter-display {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ff6b35;
            min-width: 60px;
            text-align: center;
        }
        
        .svelte-input {
            padding: 8px 12px;
            border: 2px solid #ff6b35;
            border-radius: 6px;
            font-size: 1rem;
            width: 100%;
            margin: 10px 0;
        }
        
        .svelte-list {
            list-style: none;
            padding: 0;
        }
        
        .svelte-list-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 10px 15px;
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .remove-btn:hover {
            background: #c82333;
        }
    </style>
</head>
<body>
    <div class="svelte-container">
        <!-- Navigation -->
        <nav id="navigation"></nav>
        
        <!-- Svelte Header -->
        <header class="svelte-header">
            <div class="svelte-logo">üß°</div>
            <h1 class="svelte-title">Svelte Chunk Loading</h1>
            <p class="svelte-subtitle">Demonstrating safe chunk loading with dynamic component factories and lifecycle management</p>
            
            <!-- Performance Monitor -->
            <div id="performance-monitor"></div>
        </header>
        
        <!-- Svelte Examples -->
        <main class="svelte-examples">
            <!-- Basic Dynamic Component Example -->
            <section class="example-card">
                <h2 class="example-title">
                    <span>‚ö°</span>
                    Basic Dynamic Component Loading
                </h2>
                <p class="example-description">
                    Demonstrates Svelte's dynamic component loading with safe property assignment.
                    Components are created using factory functions and mounted dynamically.
                </p>
                <div id="basic-dynamic-example"></div>
                <div class="success-indicator">
                    ‚úÖ Component loaded successfully using dynamic component factory
                </div>
            </section>
            
            <!-- Reactive State Example -->
            <section class="example-card">
                <h2 class="example-title">
                    <span>üîÑ</span>
                    Reactive State Management
                </h2>
                <p class="example-description">
                    Shows Svelte's reactive state management with dynamically loaded components,
                    including reactive declarations and event handling.
                </p>
                <div id="reactive-state-example"></div>
                <div class="success-indicator">
                    ‚úÖ Reactive state working seamlessly with chunk loading
                </div>
            </section>
            
            <!-- Getter-Only Property Handling -->
            <section class="example-card">
                <h2 class="example-title">
                    <span>üõ°Ô∏è</span>
                    Getter-Only Property Handling
                </h2>
                <p class="example-description">
                    Demonstrates how our safe assignment utility handles modules with getter-only properties,
                    preventing the original TypeError that caused chunk loading failures.
                </p>
                <div id="getter-property-example"></div>
                <div class="success-indicator">
                    ‚úÖ Getter-only properties handled safely without errors
                </div>
            </section>
            
            <!-- Lifecycle Management Example -->
            <section class="example-card">
                <h2 class="example-title">
                    <span>üîÑ</span>
                    Lifecycle Management
                </h2>
                <p class="example-description">
                    Advanced example showcasing Svelte's lifecycle management, component cleanup,
                    and proper memory management with dynamically loaded components.
                </p>
                <div id="lifecycle-example"></div>
                <div class="success-indicator">
                    ‚úÖ Proper lifecycle management and cleanup working
                </div>
            </section>
            
            <!-- Performance Metrics -->
            <section class="example-card">
                <h2 class="example-title">
                    <span>üìä</span>
                    Performance Metrics
                </h2>
                <p class="example-description">
                    Real-time performance monitoring showing loading times, memory usage, and bundle sizes.
                </p>
                <div id="performance-metrics"></div>
            </section>
            
            <!-- Source Code Viewer -->
            <section class="example-card">
                <h2 class="example-title">
                    <span>üìù</span>
                    Source Code
                </h2>
                <p class="example-description">
                    View the complete source code for all Svelte examples with syntax highlighting.
                </p>
                <div id="source-viewer"></div>
            </section>
        </main>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { createNavigation } from '../shared/navigation.js';
        import { createPerformanceMonitor } from '../shared/performance-monitor.js';
        import { createSourceViewer } from '../shared/source-viewer.js';
        import { safeChunkLoader } from '../shared/safe-chunk-loader.js';

        // Initialize navigation
        createNavigation(document.getElementById('navigation'), 'svelte');
        
        // Initialize performance monitor
        const performanceMonitor = createPerformanceMonitor();
        document.getElementById('performance-monitor').appendChild(performanceMonitor.element);
        
        // Svelte-like component factory system
        class SvelteComponentFactory {
            constructor() {
                this.components = new Map();
            }
            
            async createComponent(loader, target, props = {}) {
                try {
                    const module = await safeChunkLoader.loadChunk('svelte-component', loader);
                    const ComponentClass = module.default;
                    const instance = new ComponentClass({ target, props });
                    
                    // Store for cleanup
                    this.components.set(target, instance);
                    return instance;
                } catch (error) {
                    console.error('Failed to create Svelte component:', error);
                    target.innerHTML = `
                        <div class="error-state">
                            <span>‚ùå</span>
                            Failed to load component: ${error.message}
                        </div>
                    `;
                    throw error;
                }
            }
            
            destroyComponent(target) {
                const instance = this.components.get(target);
                if (instance && instance.$destroy) {
                    instance.$destroy();
                    this.components.delete(target);
                }
            }
            
            destroyAll() {
                for (const [target, instance] of this.components) {
                    if (instance && instance.$destroy) {
                        instance.$destroy();
                    }
                }
                this.components.clear();
            }
        }
        
        const componentFactory = new SvelteComponentFactory();
        
        // Example 1: Basic Dynamic Component
        class BasicDynamicComponent {
            constructor({ target, props = {} }) {
                this.target = target;
                this.props = props;
                this.loadTime = new Date().toLocaleTimeString();
                this.componentId = Math.random().toString(36).substr(2, 9);
                this.render();
            }
            
            render() {
                this.target.innerHTML = `
                    <div class="svelte-component">
                        <h3>üéØ Basic Dynamic Component</h3>
                        <p>This component was loaded dynamically using a component factory.</p>
                        <div class="svelte-feature">
                            <strong>Loaded at:</strong> ${this.loadTime}
                        </div>
                        <div class="svelte-feature">
                            <strong>Component ID:</strong> ${this.componentId}
                        </div>
                        <div class="svelte-feature">
                            <strong>Props:</strong> ${JSON.stringify(this.props)}
                        </div>
                    </div>
                `;
            }
            
            $destroy() {
                this.target.innerHTML = '';
            }
        }
        
        componentFactory.createComponent(
            () => Promise.resolve({ default: BasicDynamicComponent }),
            document.getElementById('basic-dynamic-example'),
            { framework: 'Svelte', type: 'basic' }
        );
        
        // Example 2: Reactive State Component
        class ReactiveStateComponent {
            constructor({ target, props = {} }) {
                this.target = target;
                this.props = props;
                
                // Reactive state
                this.state = {
                    count: 0,
                    message: 'Hello Svelte!',
                    items: []
                };
                
                this.render();
                this.bindEvents();
            }
            
            // Reactive getter (simulates Svelte's reactive declarations)
            get doubled() {
                return this.state.count * 2;
            }
            
            get messageLength() {
                return this.state.message.length;
            }
            
            get reversedMessage() {
                return this.state.message.split('').reverse().join('');
            }
            
            render() {
                this.target.innerHTML = `
                    <div class="svelte-component">
                        <h3>üîÑ Reactive State Management</h3>
                        <div class="reactive-demo">
                            <div class="counter-controls">
                                <button class="svelte-btn" data-action="decrement">-</button>
                                <div class="counter-display">${this.state.count}</div>
                                <button class="svelte-btn" data-action="increment">+</button>
                            </div>
                            <p><strong>Double:</strong> ${this.doubled}</p>
                            
                            <input 
                                class="svelte-input" 
                                type="text" 
                                value="${this.state.message}" 
                                placeholder="Type something..."
                                data-bind="message"
                            >
                            <p><strong>Length:</strong> ${this.messageLength}</p>
                            <p><strong>Reversed:</strong> ${this.reversedMessage}</p>
                            
                            <div>
                                <button class="svelte-btn" data-action="add-item">Add Item</button>
                                <ul class="svelte-list">
                                    ${this.state.items.map((item, index) => `
                                        <li class="svelte-list-item">
                                            <span>${item.name} (${item.timestamp})</span>
                                            <button class="remove-btn" data-action="remove-item" data-index="${index}">Remove</button>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        </div>
                        <div class="svelte-feature">
                            Reactive state updates and computed values
                        </div>
                    </div>
                `;
            }
            
            bindEvents() {
                // Counter buttons
                this.target.addEventListener('click', (e) => {
                    const action = e.target.dataset.action;
                    
                    if (action === 'increment') {
                        this.state.count++;
                        this.update();
                    } else if (action === 'decrement') {
                        this.state.count--;
                        this.update();
                    } else if (action === 'add-item') {
                        this.state.items.push({
                            name: `Item ${this.state.items.length + 1}`,
                            timestamp: new Date().toLocaleTimeString()
                        });
                        this.update();
                    } else if (action === 'remove-item') {
                        const index = parseInt(e.target.dataset.index);
                        this.state.items.splice(index, 1);
                        this.update();
                    }
                });
                
                // Input binding
                this.target.addEventListener('input', (e) => {
                    if (e.target.dataset.bind === 'message') {
                        this.state.message = e.target.value;
                        this.update();
                    }
                });
            }
            
            update() {
                // Simulates Svelte's reactive updates
                this.render();
                this.bindEvents();
                console.log('Svelte: Component state updated', this.state);
            }
            
            $destroy() {
                this.target.innerHTML = '';
            }
        }
        
        componentFactory.createComponent(
            () => Promise.resolve({ default: ReactiveStateComponent }),
            document.getElementById('reactive-state-example')
        );
        
        // Example 3: Getter-Only Property Handling
        class GetterPropertyComponent {
            constructor({ target, props = {} }) {
                this.target = target;
                this.props = props;
                
                // Simulate the original problem with getter-only properties
                this.moduleData = {};
                Object.defineProperty(this.moduleData, 'data', {
                    get() { 
                        return this._data || { 
                            original: 'getter-only-data', 
                            timestamp: Date.now(),
                            framework: 'Svelte'
                        }; 
                    },
                    enumerable: true,
                    configurable: true
                });
                
                this.render();
            }
            
            render() {
                const originalData = this.moduleData.data;
                const chunkData = this.moduleData.chunkData || { 
                    loaded: true, 
                    framework: 'Svelte',
                    safeAssignment: true 
                };
                
                this.target.innerHTML = `
                    <div class="svelte-component">
                        <h3>üõ°Ô∏è Getter-Only Property Handling</h3>
                        <div class="reactive-demo">
                            <p><strong>Original Data:</strong></p>
                            <pre style="background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto;">${JSON.stringify(originalData, null, 2)}</pre>
                            <p><strong>Chunk Metadata:</strong></p>
                            <pre style="background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto;">${JSON.stringify(chunkData, null, 2)}</pre>
                        </div>
                        <div class="svelte-feature">
                            ‚úÖ Safe assignment prevented TypeError on getter-only properties
                        </div>
                    </div>
                `;
            }
            
            $destroy() {
                this.target.innerHTML = '';
            }
        }
        
        componentFactory.createComponent(
            () => {
                // Create module with getter-only properties
                const module = {};
                Object.defineProperty(module, 'data', {
                    get() { 
                        return this._data || { 
                            original: 'getter-only-data', 
                            timestamp: Date.now(),
                            framework: 'Svelte'
                        }; 
                    },
                    enumerable: true,
                    configurable: true
                });
                
                module.default = GetterPropertyComponent;
                return Promise.resolve(module);
            },
            document.getElementById('getter-property-example')
        );
        
        // Example 4: Lifecycle Management
        class LifecycleComponent {
            constructor({ target, props = {} }) {
                this.target = target;
                this.props = props;
                this.mountTime = new Date().toLocaleTimeString();
                this.updateCount = 0;
                this.timers = [];
                
                this.state = {
                    seconds: 0,
                    isRunning: false
                };
                
                this.onMount();
                this.render();
                this.bindEvents();
            }
            
            onMount() {
                console.log('Svelte: Lifecycle component mounted at', this.mountTime);
                
                // Start a timer (simulates onMount lifecycle)
                const timer = setInterval(() => {
                    if (this.state.isRunning) {
                        this.state.seconds++;
                        this.update();
                    }
                }, 1000);
                
                this.timers.push(timer);
            }
            
            render() {
                this.target.innerHTML = `
                    <div class="svelte-component">
                        <h3>üîÑ Lifecycle Management</h3>
                        <div class="reactive-demo">
                            <div>
                                <h4>Component Lifecycle</h4>
                                <p><strong>Mounted at:</strong> ${this.mountTime}</p>
                                <p><strong>Updates:</strong> ${this.updateCount}</p>
                            </div>
                            
                            <div>
                                <h4>Timer Demo</h4>
                                <div class="counter-controls">
                                    <button class="svelte-btn" data-action="toggle-timer">
                                        ${this.state.isRunning ? 'Stop' : 'Start'} Timer
                                    </button>
                                    <button class="svelte-btn" data-action="reset-timer">Reset</button>
                                </div>
                                <div class="counter-display">${this.state.seconds}s</div>
                            </div>
                            
                            <div>
                                <h4>Memory Management</h4>
                                <p>Active timers: ${this.timers.length}</p>
                                <p>Component will clean up all resources on destroy</p>
                            </div>
                        </div>
                        <div class="svelte-feature">
                            Proper lifecycle hooks and cleanup management
                        </div>
                    </div>
                `;
            }
            
            bindEvents() {
                this.target.addEventListener('click', (e) => {
                    const action = e.target.dataset.action;
                    
                    if (action === 'toggle-timer') {
                        this.state.isRunning = !this.state.isRunning;
                        this.update();
                    } else if (action === 'reset-timer') {
                        this.state.seconds = 0;
                        this.state.isRunning = false;
                        this.update();
                    }
                });
            }
            
            update() {
                this.updateCount++;
                this.render();
                this.bindEvents();
            }
            
            $destroy() {
                console.log('Svelte: Lifecycle component destroyed, cleaning up resources');
                
                // Clean up timers (simulates onDestroy lifecycle)
                this.timers.forEach(timer => clearInterval(timer));
                this.timers = [];
                
                this.target.innerHTML = '';
            }
        }
        
        componentFactory.createComponent(
            () => Promise.resolve({ default: LifecycleComponent }),
            document.getElementById('lifecycle-example')
        );
        
        // Performance Metrics Display
        class PerformanceMetrics {
            constructor({ target }) {
                this.target = target;
                this.metrics = {
                    loadTime: 0,
                    componentCount: 4,
                    memoryUsage: 0,
                    bundleSize: '~12KB'
                };
                
                this.collectMetrics();
                this.render();
            }
            
            collectMetrics() {
                const startTime = performance.now();
                
                setTimeout(() => {
                    this.metrics.loadTime = Math.round(performance.now() - startTime);
                    
                    if (performance.memory) {
                        this.metrics.memoryUsage = Math.round(performance.memory.usedJSHeapSize / 1024 / 1024 * 100) / 100;
                    }
                    
                    this.render();
                }, 100);
            }
            
            render() {
                this.target.innerHTML = `
                    <div class="metrics-display">
                        <h4>üìä Svelte Performance Metrics</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                            <div>
                                <strong>Load Time:</strong><br>
                                ${this.metrics.loadTime}ms
                            </div>
                            <div>
                                <strong>Components:</strong><br>
                                ${this.metrics.componentCount} loaded
                            </div>
                            <div>
                                <strong>Memory Usage:</strong><br>
                                ${this.metrics.memoryUsage}MB
                            </div>
                            <div>
                                <strong>Bundle Size:</strong><br>
                                ${this.metrics.bundleSize}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            $destroy() {
                this.target.innerHTML = '';
            }
        }
        
        componentFactory.createComponent(
            () => Promise.resolve({ default: PerformanceMetrics }),
            document.getElementById('performance-metrics')
        );
        
        // Source Code Viewer
        const sourceViewer = createSourceViewer([
            {
                name: 'Basic Dynamic Component',
                language: 'javascript',
                code: `class BasicDynamicComponent {
  constructor({ target, props = {} }) {
    this.target = target;
    this.props = props;
    this.loadTime = new Date().toLocaleTimeString();
    this.render();
  }
  
  render() {
    this.target.innerHTML = \`
      <div class="svelte-component">
        <h3>Basic Dynamic Component</h3>
        <p>Loaded at: \${this.loadTime}</p>
      </div>
    \`;
  }
  
  $destroy() {
    this.target.innerHTML = '';
  }
}`
            },
            {
                name: 'Reactive State Management',
                language: 'javascript',
                code: `class ReactiveStateComponent {
  constructor({ target }) {
    this.target = target;
    this.state = { count: 0, message: 'Hello!' };
    this.render();
    this.bindEvents();
  }
  
  get doubled() {
    return this.state.count * 2;
  }
  
  update() {
    this.render();
    this.bindEvents();
  }
  
  bindEvents() {
    this.target.addEventListener('click', (e) => {
      if (e.target.dataset.action === 'increment') {
        this.state.count++;
        this.update();
      }
    });
  }
}`
            },
            {
                name: 'Component Factory',
                language: 'javascript',
                code: `class SvelteComponentFactory {
  async createComponent(loader, target, props = {}) {
    const module = await safeChunkLoader.loadChunk('svelte-component', loader);
    const ComponentClass = module.default;
    const instance = new ComponentClass({ target, props });
    
    this.components.set(target, instance);
    return instance;
  }
  
  destroyComponent(target) {
    const instance = this.components.get(target);
    if (instance && instance.$destroy) {
      instance.$destroy();
      this.components.delete(target);
    }
  }
}`
            }
        ]);
        
        document.getElementById('source-viewer').appendChild(sourceViewer);
        
        // Track performance
        performanceMonitor.trackMetric('svelte-load-time', performance.now());
        performanceMonitor.trackMetric('svelte-components', 4);
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            componentFactory.destroyAll();
        });
        
        console.log('‚úÖ Svelte chunk loading examples initialized successfully');
    </script>
</body>
</html>