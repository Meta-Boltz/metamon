const MTMRouter = { _signals: new Map(), _subscribers: new Map(), _routes: new Map(), _currentRoute: null, create(key, initialValue) { if (!this._signals.has(key)) { this._signals.set(key, initialValue); this._subscribers.set(key, new Set())} return { get value() { return MTMRouter._signals.get(key)}, set value(newValue) { MTMRouter._signals.set(key, newValue); MTMRouter._notifySubscribers(key, newValue)}, subscribe(callback) { MTMRouter._subscribers.get(key).add(callback)} }}, _notifySubscribers(key, value) { if (this._subscribers.has(key)) { this._subscribers.get(key).forEach(callback => callback(value))} }, navigate(path) { if (this._currentRoute !== path) { this._currentRoute = path; window.history.pushState({ path }, '', path); this.updatePage(path)} }, updatePage(path) { const route = this._routes.get(path); if (route && route.title) { document.title = route.title} this.emit('route-changed', { path, route })}, setupLinkInterception() { document.addEventListener('click', (e) => { const link = e.target.closest('a[data-link="true"], a:not([external]):not([href^="http"]):not([href^="mailto"]):not([href^="tel"])'); if (link && link.href && !link.hasAttribute('external')) { const url = new URL(link.href); if (url.origin === window.location.origin) { e.preventDefault(); this.navigate(url.pathname)} } })}, setupPopState() { window.addEventListener('popstate', (e) => { const path = e.state?.path || window.location.pathname; this._currentRoute = path; this.updatePage(path)})}, init() { this.setupLinkInterception(); this.setupPopState(); this._currentRoute = window.location.pathname}, emit(event, data) { console.log('MTM Router Event:', event, data); window.dispatchEvent(new CustomEvent('mtm-' + event, { detail: data }))} }; const MTMComponents = { _registry: new Map(), register(name, type, factory) { this._registry.set(name, { type, factory })}, mount(element, name, props = {}) { const component = this._registry.get(name); if (component) { const instance = component.factory(props); if (typeof instance.mount === 'function') { instance.mount(element)} else { element.innerHTML = instance} } }, mountAll() { document.querySelectorAll('[data-component]').forEach(el => { const componentName = el.getAttribute('data-component'); const componentType = el.getAttribute('data-type'); const props = {}; Array.from(el.attributes).forEach(attr => { if (attr.name.startsWith('data-prop-')) { const propName = attr.name.replace('data-prop-', ''); props[propName] = attr.value} }); this.mount(el, componentName, props)})} }; window.signal = MTMRouter; const pageMetadata = { "route": "/external-test", "title": "External Mode Test", "description": "Testing external JavaScript compilation", "compileJsMode": "external.js" }; MTMRouter._routes.set('/external-test', pageMetadata); function ComponentPage() { const items = MTMRouter.create('items', ['Item 1', 'Item 2', 'Item 3']); const newItem = MTMRouter.create('newItem', ""); const addItem = (()) => { $addItem = () => { if ($newItem.trim()) { $items.value = [...$items.value, $newItem.trim()] $newItem = "" } } }; const removeItem = ((index)) => { $removeItem = (index) => { $items.value = $items.filter((_, i) => i !== index) } }; MTMComponents.register('VueButton', 'vue', (props) => { return `<div class="vue-component">${component.name} Component (vue)</div>`}); MTMComponents.register('SolidCounter', 'react', (props) => { return `<div class="react-component">${component.name} Component (react)</div>`}); const container = document.getElementById('app'); const updateAll = () => { container.querySelectorAll('[data-bind="items"]').forEach(el => { el.textContent = items.value}); container.querySelectorAll('[data-bind="newItem"]').forEach(el => { el.textContent = newItem.value}); container.querySelectorAll('[data-if]').forEach(el => { const condition = el.getAttribute('data-if'); let shouldShow = false; try { let evalStr = condition; evalStr = evalStr.replace(/\items/g, 'items.value'); evalStr = evalStr.replace(/\newItem/g, 'newItem.value'); shouldShow = eval(evalStr)} catch (e) { console.warn('Condition failed:', condition, e)} el.style.display = shouldShow ? 'block' : 'none'})}; updateAll(); MTMComponents.mountAll(); items.subscribe(() => updateAll()); container.querySelectorAll('[data-event-click="addItem"]').forEach(el => { el.addEventListener('click', (e) => { e.preventDefault(); addItem()})}); container.querySelectorAll('[data-event-click="removeItem"]').forEach(el => { el.addEventListener('click', (e) => { e.preventDefault(); removeItem()})})} document.addEventListener('DOMContentLoaded', () => { MTMRouter.init(); ComponentPage(); console.log('ğŸ”® Enhanced MTM Page loaded:', pageMetadata)});